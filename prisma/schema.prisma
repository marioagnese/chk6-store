generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Product {
  id          String        @id @default(cuid())
  handle      String        @unique
  title       String
  description String?
  status      ProductStatus @default(ACTIVE)
  vendor      String?       @default("CHK6")
  tags        String[]      @default([])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  images      ProductImage[]
  variants    Variant[]
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int     @default(0)

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Variant {
  id               String   @id @default(cuid())
  productId        String
  sku              String   @unique
  title            String   // "Black / L"
  color            String?
  size             String?
  priceCents       Int
  currency         String   @default("usd")
  active           Boolean  @default(true)

  stripeProductId  String?
  stripePriceId    String?  @unique

  inventoryOnHand   Int     @default(0)
  inventoryReserved Int     @default(0)

  product          Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems       OrderItem[]
}

model Customer {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  phone     String?
  createdAt DateTime @default(now())

  orders    Order[]
}

model Address {
  id         String  @id @default(cuid())
  name       String?
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String
  country    String

  shippingForOrders Order[] @relation("OrderShippingAddress")
  billingForOrders  Order[] @relation("OrderBillingAddress")
}

model Order {
  id          String      @id @default(cuid())
  orderNumber Int         @unique @default(autoincrement())

  status      OrderStatus @default(CREATED)

  customerId    String?
  customerEmail String

  subtotalCents Int
  shippingCents Int        @default(0)
  taxCents      Int        @default(0)
  totalCents    Int
  currency      String     @default("usd")

  stripeCheckoutSessionId String? @unique
  stripePaymentIntentId   String? @unique

  shippingAddressId String?
  billingAddressId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer        Customer?  @relation(fields: [customerId], references: [id])
  items           OrderItem[]

  shippingAddress Address?   @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address?   @relation("OrderBillingAddress", fields: [billingAddressId], references: [id])

  events          OrderEvent[]
}

model OrderItem {
  id             String @id @default(cuid())
  orderId        String
  variantId      String

  sku            String
  title          String
  unitPriceCents Int
  qty            Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id])
}

model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  type      String
  payload   Json
  createdAt DateTime @default(now())

  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}

enum OrderStatus {
  CREATED
  PAID
  FULFILLING
  SHIPPED
  CANCELED
  REFUNDED
}
